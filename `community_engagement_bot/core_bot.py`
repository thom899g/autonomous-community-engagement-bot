from typing import Optional, Dict, Any
import logging
import yaml
from adapters import TwitterAdapter, RedditAdapter
from nlp_module import TextGenerator
from sentiment_analyzer import SentimentAnalyzer

logger = logging.getLogger(__name__)

class CoreBot:
    def __init__(self, config_path: str):
        self.config = self._load_config(config_path)
        
        # Initialize adapters
        self.adapters = {
            'twitter': TwitterAdapter(self.config['platforms']['twitter']),
            'reddit': RedditAdapter(self.config['platforms']['reddit'])
        }
        
        # Initialize NLP and sentiment modules
        self.nlp = TextGenerator(self.config['nlp']['model_path'])
        self.sentiment_analyzer = SentimentAnalyzer()
        
        self.current_platform: Optional[str] = None
        
    def _load_config(self, config_path: str) -> Dict[Any, Any]:
        """Load configuration from YAML file."""
        try:
            with open(config_path, 'r') as f:
                return yaml.safe_load(f)
        except Exception as e:
            logger.error(f"Failed to load config: {e}")
            raise

    def engage(self, platform: str, message: str) -> str:
        """Process and respond to user messages."""
        try:
            # Annotate for type checking
            assert isinstance(platform, str)
            assert isinstance(message, str)
            
            # Determine sentiment
            sentiment = self.sentiment_analyzer.analyze(message)
            logger.info(f"User sentiment: {sentiment}")
            
            # Generate response
            response = self.nlp.generate_response(message, sentiment=sentiment)
            logger.debug(f"Generated response: {response}")
            
            return response
            
        except Exception as e:
            logger.error(f"Engagement failed: {e}")
            raise

    def switch_platform(self, platform: str) -> None:
        """Switch the current platform adapter."""
        if platform in self.adapters:
            self.current_platform = platform
            logger.info(f"Switched to platform: {platform}")
        else:
            raise ValueError(f"Platform {platform} not supported")

    def handle_error(self, error: Exception, context: str) -> None:
        """Handle exceptions gracefully."""
        logger.error(f"Error in {context}: {str(error)}")
        # Implement custom error handling logic here